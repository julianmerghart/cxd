#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#define BATCH_SIZE 1000
#define HASH_LEN 65

typedef struct {
    char buffer[BATCH_SIZE][HASH_LEN];
    int count;
} WriteBuffer;

WriteBuffer disk_buffer;

void flush_to_disk() {
    if (disk_buffer.count == 0) return;

    FILE *fp = fopen("cxd_votes.db", "a");
    if (!fp) {
        perror("CRITICAL: Disk Write Failed");
        return;
    }

    // Write all buffered votes in one go
    for (int i = 0; i < disk_buffer.count; i++) {
        fprintf(fp, "%s\n", disk_buffer.buffer[i]);
    }
    
    fclose(fp);
    printf("[DISK] Flushed %d votes to persistent storage.\n", disk_buffer.count);
    
    // Reset buffer
    disk_buffer.count = 0;
}

// Replaces the old persist_vote function
void persist_vote_optimized(const char* hex_hash) {
    // 1. Write to RAM buffer (Instant)
    strcpy(disk_buffer.buffer[disk_buffer.count], hex_hash);
    disk_buffer.count++;

    // 2. Only flush if buffer is full
    if (disk_buffer.count >= BATCH_SIZE) {
        flush_to_disk();
    }
}

// IMPORTANT: You must also call flush_to_disk() 
// when the server shuts down or on a timer (e.g. every 1 sec)
// to ensure the last few votes aren't lost.
